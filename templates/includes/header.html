<header class="header">
    
    <section class="header__informacoes">
        <section class="logo">
            <img src="{{ url_for('static', filename='img/logo.png') }}" class="logo__img" alt="Logo Recoopera">
        </section>
        
        <section class="header__informacoes-cooperativa" id="header-info-cooperativa" style="display: none;"> 
            <h3 id="header-nome-cooperativa"></h3> 
            <small id="header-endereco-cooperativa"></small>
        </section>

        <section class="header__informacoes-admin" id="header-info-admin" style="display: none;">
             <h3>Painel Administrativo</h3>
             <small id="header-nome-admin"></small> 
        </section>
    </section>

    <section class="header__acoes">
        <a href="/pagina-inicial" id="home-link"> <i class="fa-solid fa-house"></i>
        </a>
        <a href="#" id="logout-link"> 
           <i class="fa-solid fa-right-from-bracket"></i> 
        </a>
    </section>
</header>

<style>
    .header {
        width: 100%; 
        height: 80px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--verde-principal);
        padding: 0 15px;
        box-sizing: border-box; 
    }

    .header__informacoes {
        display: flex;
        align-items: center;
        gap: 15px; 
    }

    .logo {
        width: 60px;
        height: 60px;
        flex-shrink: 0; 
    }
    .logo__img {
        width: 100%;
        height: 100%;
        border-radius: 50%; 
        object-fit: cover; 
    }

    .header__informacoes-cooperativa,
    .header__informacoes-admin {
        color: var(--verde-claro);
        line-height: 1.3; 
    }
    .header__informacoes-cooperativa h3,
    .header__informacoes-admin h3 {
        margin-bottom: 0.1rem;
        font-size: 1rem; 
        font-weight: 600;
        color: var(--branco); 
    }
    .header__informacoes-cooperativa small,
    .header__informacoes-admin small {
        color: #e0e0e0c9; 
        font-size: 0.8rem;
        display: block; 
    }

    .header__acoes {
        display: flex;
        align-items: center;
        gap: 20px; 
    }

    .header__acoes a i { 
        font-size: 26px; 
        color: var(--verde-claro); 
        transition: transform 0.2s ease, color 0.2s ease; 
    }
    .header__acoes a:hover i {
        transform: scale(1.15); 
        color: var(--branco); 
    }

</style>

<!-- Carrega SweetAlert2 para garantir que esteja disponível em todas as páginas -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const { getUserInfo } = require('../../static/utils/loginGenerico.js');

document.addEventListener('DOMContentLoaded', async () => {

    const token = localStorage.getItem('session_token');
    const homeLink = document.getElementById('home-link');
    const logoutLink = document.getElementById('logout-link');
    const headerInfoCoop = document.getElementById('header-info-cooperativa');
    const headerNomeCoop = document.getElementById('header-nome-cooperativa');
    const headerEndCoop = document.getElementById('header-endereco-cooperativa');
    const headerInfoAdmin = document.getElementById('header-info-admin');
    const headerNomeAdmin = document.getElementById('header-nome-admin');

    async function handleLogout() {
        localStorage.removeItem('session_token');
        
        // Aguarda o SweetAlert estar disponível (caso esteja sendo carregado)
        let swalReady = typeof Swal !== 'undefined';
        if (!swalReady) {
            // Tenta aguardar um pouco caso o SweetAlert esteja sendo carregado
            await new Promise(resolve => {
                let attempts = 0;
                const checkSwal = setInterval(() => {
                    if (typeof Swal !== 'undefined') {
                        clearInterval(checkSwal);
                        swalReady = true;
                        resolve();
                    }
                    attempts++;
                    if (attempts > 20) { // Espera até 2 segundos (20 * 100ms)
                        clearInterval(checkSwal);
                        resolve();
                    }
                }, 100);
            });
        }
        
        if (typeof Swal !== 'undefined' && Swal.fire) {
            Swal.fire({
                title: 'Desconectado',
                text: 'Você saiu da sua conta.',
                icon: 'info',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                window.location.href = '/'; 
            });
        } else {
            alert('Você foi desconectado.');
            window.location.href = '/'; 
        }
    }

    if (logoutLink) {
        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            await handleLogout();
        });
    }

    if (!token || !homeLink) {
        if(logoutLink) logoutLink.style.display = 'none';
        if(homeLink) homeLink.style.display = 'none'; 
        return; 
    }
    
    try {
        
        //#region Validação dos dados do usuário

        let user_data = sessionStorage.getItem('usuario', null);

        if (user_data == null) 
        {
            const session_token = localStorage.getItem('session_token', null);

            if (session_token == null)
            {
                user_data = await getUserInfo(session_token);
                sessionStorage.setItem('usuario', user_data);
            }

            else window.location.href = '/';
        }

        //#endregion

        if (user_data.tipo === 'gestor' || user_data.tipo === 'root') {
            homeLink.href = '/pagina-inicial/gestor';
            if(headerInfoAdmin && headerNomeAdmin && user_data.nome) {
                headerNomeAdmin.textContent = user_data.nome.split(' ')[0];
                headerInfoAdmin.style.display = 'block';
            }
        } else if (user_data.tipo === 'cooperativa') {
            homeLink.href = '/pagina-inicial';
             if(headerInfoCoop && headerNomeCoop && user_data.nome) { 
                headerNomeCoop.textContent = user_data.nome; 
                headerInfoCoop.style.display = 'block';
             }
        } else if (user_data.tipo === 'cooperado') {
             homeLink.href = '/pagina-inicial'; 
        }

    } catch (error) {
        console.error('Erro ao buscar dados do usuário para o header:', error);
    }
});
</script>